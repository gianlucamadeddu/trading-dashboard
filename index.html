<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - Mt4 & Plus500</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Firebase v9 SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .trading-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .results-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border-left: 5px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-value.positive {
            color: #28a745;
        }

        .stat-value.negative {
            color: #dc3545;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .objectives {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .objective-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .objective-card h4 {
            color: #d63384;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 25px;
            height: 10px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 25px;
            transition: width 0.5s ease;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .period-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-btn.active, .period-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .dashboard-card {
                padding: 18px;
            }
            
            .stat-value {
                font-size: 2em;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1201px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            z-index: 1000;
        }

        .connection-status.online {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status">üîÑ Connessione...</div>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ Trading Dashboard</h1>
            <p>Monitora i tuoi progressi su Mt4 e Plus500</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('input')">üìù Inserimento Dati</button>
                <button class="tab" onclick="showTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="showTab('history')">üìà Storico</button>
            </div>

            <!-- Tab Inserimento Dati -->
            <div id="input" class="tab-content active">
                <div class="trading-form">
                    <h2>Inserisci Nuova Operazione</h2>
                    <form id="tradingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="platform">Piattaforma</label>
                                <select id="platform" required>
                                    <option value="">Seleziona piattaforma</option>
                                    <option value="Mt4">Mt4</option>
                                    <option value="Plus500">Plus500</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lots">Lotti</label>
                                <input type="number" id="lots" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="pointValue">Valore 1 Punto (‚Ç¨)</label>
                                <input type="number" id="pointValue" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="profitLoss">Ricavo/Perdita (‚Ç¨)</label>
                                <input type="number" id="profitLoss" step="0.01" required>
                            </div>
                        </div>
                        <button type="submit" class="btn">üíæ Salva Operazione</button>
                    </form>
                </div>

                <div id="calculatedResult" class="results-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Piattaforma</th>
                                <th>Lotti</th>
                                <th>Valore 1 Punto</th>
                                <th>Punti Realizzati/Persi</th>
                                <th>Ricavo/Perdita</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Dashboard -->
            <div id="dashboard" class="tab-content">
                <div class="objectives">
                    <div class="objective-card">
                        <h4>üéØ Mt4 - Obiettivo Giornaliero</h4>
                        <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">
                            <span id="mt4Progress">0</span> / 15 punti
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="mt4ProgressBar" style="width: 0%"></div>
                        </div>
                        <span id="mt4Status">In corso...</span>
                    </div>
                    <div class="objective-card">
                        <h4>üéØ Plus500 - Obiettivo Giornaliero</h4>
                        <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">
                            <span id="plus500Progress">0</span> / 20 punti
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="plus500ProgressBar" style="width: 0%"></div>
                        </div>
                        <span id="plus500Status">In corso...</span>
                    </div>
                </div>

                <div class="period-selector">
                    <button class="period-btn active" onclick="changePeriod('daily')">Giornaliero</button>
                    <button class="period-btn" onclick="changePeriod('weekly')">Settimanale</button>
                    <button class="period-btn" onclick="changePeriod('monthly')">Mensile</button>
                </div>

                <div class="dashboard-grid">
                    <!-- Mt4 Stats -->
                    <div class="dashboard-card" style="border-left-color: #1e3c72;">
                        <h3>üí∞ Mt4 - Ricavi</h3>
                        <div class="stat-value" id="mt4Profit">‚Ç¨0.00</div>
                        <div class="stat-label">Periodo selezionato</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #1e3c72;">
                        <h3>üìà Mt4 - Punti</h3>
                        <div class="stat-value" id="mt4Points">0</div>
                        <div class="stat-label">Punti realizzati</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #1e3c72;">
                        <h3>üî¢ Mt4 - Operazioni</h3>
                        <div class="stat-value" id="mt4Trades">0</div>
                        <div class="stat-label">Operazioni eseguite</div>
                    </div>
                    
                    <!-- Plus500 Stats -->
                    <div class="dashboard-card" style="border-left-color: #667eea;">
                        <h3>üí∞ Plus500 - Ricavi</h3>
                        <div class="stat-value" id="plus500Profit">‚Ç¨0.00</div>
                        <div class="stat-label">Periodo selezionato</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #667eea;">
                        <h3>üìà Plus500 - Punti</h3>
                        <div class="stat-value" id="plus500Points">0</div>
                        <div class="stat-label">Punti realizzati</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #667eea;">
                        <h3>üî¢ Plus500 - Operazioni</h3>
                        <div class="stat-value" id="plus500Trades">0</div>
                        <div class="stat-label">Operazioni eseguite</div>
                    </div>
                    
                    <!-- Totali Generali -->
                    <div class="dashboard-card" style="border-left-color: #28a745;">
                        <h3>üí∞ Ricavi Totali</h3>
                        <div class="stat-value" id="totalProfit">‚Ç¨0.00</div>
                        <div class="stat-label">Somma Mt4 + Plus500</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #28a745;">
                        <h3>üìà Punti Totali</h3>
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">Somma Mt4 + Plus500</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #28a745;">
                        <h3>üî¢ Operazioni Totali</h3>
                        <div class="stat-value" id="totalTrades">0</div>
                        <div class="stat-label">Somma Mt4 + Plus500</div>
                    </div>
                    
                    <!-- Media Giornaliera -->
                    <div class="dashboard-card" style="border-left-color: #20c997;">
                        <h3>üìä Media Giornaliera</h3>
                        <div class="stat-value" id="dailyAverage">‚Ç¨0.00</div>
                        <div class="stat-label">Ricavo medio per giorno</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #6c757d;">
                        <h3>‚öñÔ∏è Confronto Efficienza</h3>
                        <div class="stat-value" style="font-size: 1.2em; line-height: 1.3;">
                            <div style="color: #1e3c72;">Mt4: <span id="mt4Efficiency">‚Ç¨0/op</span></div>
                            <div style="color: #667eea; margin-top: 5px;">Plus500: <span id="plus500Efficiency">‚Ç¨0/op</span></div>
                        </div>
                        <div class="stat-label">Ricavo per operazione</div>
                    </div>
                    <div class="dashboard-card" style="border-left-color: #f59f00;">
                        <h3>üèÜ Piattaforma Migliore</h3>
                        <div class="stat-value" style="font-size: 1.5em;" id="bestPlatform">-</div>
                        <div class="stat-label" id="bestPlatformReason">Periodo selezionato</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìà Andamento Ricavi per Piattaforma</h3>
                    <canvas id="profitChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üéØ Punti per Piattaforma</h3>
                    <canvas id="pointsChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Tab Storico -->
            <div id="history" class="tab-content">
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Piattaforma</th>
                                <th>Lotti</th>
                                <th>Valore 1 Punto</th>
                                <th>Punti</th>
                                <th>Ricavo/Perdita</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDaUKP9kXT5BuWI0FngI0pNUiRqJ0QivhA",
            authDomain: "trading-dashboard-e71f5.firebaseapp.com",
            projectId: "trading-dashboard-e71f5",
            storageBucket: "trading-dashboard-e71f5.firebasestorage.app",
            messagingSenderId: "914455597432",
            appId: "1:914455597432:web:81239bae6606aa2149788d"
        };

        // Inizializza Firebase
        let db;
        let isFirebaseConnected = false;

        // Controlla se Firebase √® disponibile
        function initializeFirebase() {
            if (typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    isFirebaseConnected = true;
                    updateConnectionStatus('online');
                    console.log('Firebase connesso con successo');
                } catch (error) {
                    console.error('Errore connessione Firebase:', error);
                    updateConnectionStatus('offline');
                }
            } else {
                console.log('Firebase non disponibile, funziona in modalit√† offline');
                updateConnectionStatus('offline');
            }
        }

        // Aspetta che Firebase sia caricato
        window.addEventListener('load', function() {
            setTimeout(initializeFirebase, 1000);
        });

        // Variabili globali
        let trades = JSON.parse(localStorage.getItem('trades') || '[]');
        let currentPeriod = 'daily';
        let profitChart, pointsChart;

        // Aggiorna stato connessione
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (status === 'online') {
                statusElement.textContent = 'üü¢ Online';
                statusElement.className = 'connection-status online';
            } else {
                statusElement.textContent = 'üî¥ Offline';
                statusElement.className = 'connection-status offline';
            }
        }

        // Gestione tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
                setTimeout(() => {
                    initCharts();
                }, 100);
            } else if (tabName === 'history') {
                updateHistory();
            }
        }

        // Gestione form
        document.getElementById('tradingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const platform = document.getElementById('platform').value;
            const lots = parseFloat(document.getElementById('lots').value);
            const pointValue = parseFloat(document.getElementById('pointValue').value);
            const profitLoss = parseFloat(document.getElementById('profitLoss').value);
            
            // Calcolo punti realizzati/persi
            const pointsRealized = profitLoss / pointValue;
            
            const trade = {
                id: Date.now(),
                platform,
                lots,
                pointValue,
                pointsRealized: Math.round(pointsRealized * 100) / 100,
                profitLoss,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().getTime()
            };
            
            trades.push(trade);
            localStorage.setItem('trades', JSON.stringify(trades));
            
            // Salva su Firebase se connesso
            if (isFirebaseConnected) {
                saveTrade(trade);
            }
            
            displayResult(trade);
            this.reset();
            
            showAlert('Operazione salvata con successo!', 'success');
        });

        // Funzioni Firebase
        async function saveTrade(trade) {
            if (!isFirebaseConnected) return;
            
            try {
                await db.collection('trades').add(trade);
                console.log('Trade salvato su Firebase');
            } catch (error) {
                console.error('Errore salvataggio Firebase:', error);
                showAlert('Errore durante il salvataggio online. Dati salvati localmente.', 'error');
            }
        }

        async function loadTrades() {
            if (!isFirebaseConnected) {
                console.log('Firebase non connesso, uso dati locali');
                return;
            }
            
            try {
                const snapshot = await db.collection('trades').orderBy('timestamp', 'desc').get();
                const firebaseTrades = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                
                // Unisci con i dati locali ed elimina duplicati
                const allTrades = [...trades, ...firebaseTrades];
                const uniqueTrades = allTrades.filter((trade, index, self) => 
                    index === self.findIndex(t => t.timestamp === trade.timestamp)
                );
                
                trades = uniqueTrades.sort((a, b) => b.timestamp - a.timestamp);
                localStorage.setItem('trades', JSON.stringify(trades));
                console.log('Trades caricati da Firebase');
            } catch (error) {
                console.error('Errore caricamento Firebase:', error);
                console.log('Uso dati locali');
            }
        }

        async function deleteTradeFromFirebase(tradeTimestamp) {
            if (!isFirebaseConnected) return;
            
            try {
                const snapshot = await db.collection('trades')
                    .where('timestamp', '==', tradeTimestamp)
                    .get();
                snapshot.forEach(doc => doc.ref.delete());
            } catch (error) {
                console.error('Errore eliminazione Firebase:', error);
            }
        }

        function displayResult(trade) {
            const resultDiv = document.getElementById('calculatedResult');
            const tbody = document.getElementById('resultBody');
            
            tbody.innerHTML = `
                <tr>
                    <td>${trade.platform}</td>
                    <td>${trade.lots}</td>
                    <td>‚Ç¨${trade.pointValue.toFixed(2)}</td>
                    <td class="${trade.pointsRealized >= 0 ? 'positive' : 'negative'}">${trade.pointsRealized.toFixed(2)}</td>
                    <td class="${trade.profitLoss >= 0 ? 'positive' : 'negative'}">‚Ç¨${trade.profitLoss.toFixed(2)}</td>
                    <td>${new Date(trade.timestamp).toLocaleString('it-IT')}</td>
                </tr>
            `;
            
            resultDiv.style.display = 'block';
        }

        function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateDashboard();
            updateCharts();
        }

        function updateDashboard() {
            const filteredTrades = getFilteredTrades();
            const today = new Date().toISOString().split('T')[0];
            const todayTrades = trades.filter(trade => trade.date === today);
            
            // Aggiorna obiettivi giornalieri
            const mt4TodayPoints = todayTrades
                .filter(trade => trade.platform === 'Mt4')
                .reduce((sum, trade) => sum + trade.pointsRealized, 0);
            
            const plus500TodayPoints = todayTrades
                .filter(trade => trade.platform === 'Plus500')
                .reduce((sum, trade) => sum + trade.pointsRealized, 0);
            
            updateObjectiveProgress('mt4', mt4TodayPoints, 15);
            updateObjectiveProgress('plus500', plus500TodayPoints, 20);
            
            // Calcoli separati per Mt4
            const mt4Trades = filteredTrades.filter(trade => trade.platform === 'Mt4');
            const mt4TotalProfit = mt4Trades.reduce((sum, trade) => sum + trade.profitLoss, 0);
            const mt4TotalPoints = mt4Trades.reduce((sum, trade) => sum + trade.pointsRealized, 0);
            const mt4TotalOperations = mt4Trades.length;
            
            // Calcoli separati per Plus500
            const plus500Trades = filteredTrades.filter(trade => trade.platform === 'Plus500');
            const plus500TotalProfit = plus500Trades.reduce((sum, trade) => sum + trade.profitLoss, 0);
            const plus500TotalPoints = plus500Trades.reduce((sum, trade) => sum + trade.pointsRealized, 0);
            const plus500TotalOperations = plus500Trades.length;
            
            // Totali generali
            const totalProfit = mt4TotalProfit + plus500TotalProfit;
            const totalPoints = mt4TotalPoints + plus500TotalPoints;
            const totalTrades = mt4TotalOperations + plus500TotalOperations;
            
            // Aggiorna statistiche Mt4
            document.getElementById('mt4Profit').textContent = `‚Ç¨${mt4TotalProfit.toFixed(2)}`;
            document.getElementById('mt4Profit').className = `stat-value ${mt4TotalProfit >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('mt4Points').textContent = mt4TotalPoints.toFixed(2);
            document.getElementById('mt4Points').className = `stat-value ${mt4TotalPoints >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('mt4Trades').textContent = mt4TotalOperations;
            
            // Aggiorna statistiche Plus500
            document.getElementById('plus500Profit').textContent = `‚Ç¨${plus500TotalProfit.toFixed(2)}`;
            document.getElementById('plus500Profit').className = `stat-value ${plus500TotalProfit >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('plus500Points').textContent = plus500TotalPoints.toFixed(2);
            document.getElementById('plus500Points').className = `stat-value ${plus500TotalPoints >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('plus500Trades').textContent = plus500TotalOperations;
            
            // Aggiorna totali generali
            document.getElementById('totalProfit').textContent = `‚Ç¨${totalProfit.toFixed(2)}`;
            document.getElementById('totalProfit').className = `stat-value ${totalProfit >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('totalPoints').textContent = totalPoints.toFixed(2);
            document.getElementById('totalPoints').className = `stat-value ${totalPoints >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('totalTrades').textContent = totalTrades;
            
            // Media giornaliera
            const days = getDaysInPeriod();
            const dailyAverage = days > 0 ? totalProfit / days : 0;
            document.getElementById('dailyAverage').textContent = `‚Ç¨${dailyAverage.toFixed(2)}`;
            document.getElementById('dailyAverage').className = `stat-value ${dailyAverage >= 0 ? 'positive' : 'negative'}`;
            
            // Efficienza per operazione
            const mt4Efficiency = mt4TotalOperations > 0 ? mt4TotalProfit / mt4TotalOperations : 0;
            const plus500Efficiency = plus500TotalOperations > 0 ? plus500TotalProfit / plus500TotalOperations : 0;
            
            document.getElementById('mt4Efficiency').textContent = `‚Ç¨${mt4Efficiency.toFixed(2)}/op`;
            document.getElementById('plus500Efficiency').textContent = `‚Ç¨${plus500Efficiency.toFixed(2)}/op`;
            
            // Piattaforma migliore
            updateBestPlatform(mt4TotalProfit, plus500TotalProfit, mt4Efficiency, plus500Efficiency);
        }
        
        function updateBestPlatform(mt4Profit, plus500Profit, mt4Efficiency, plus500Efficiency) {
            const bestPlatformEl = document.getElementById('bestPlatform');
            const bestPlatformReasonEl = document.getElementById('bestPlatformReason');
            
            if (mt4Profit === 0 && plus500Profit === 0) {
                bestPlatformEl.textContent = '-';
                bestPlatformEl.className = 'stat-value';
                bestPlatformReasonEl.textContent = 'Nessuna operazione';
                return;
            }
            
            if (mt4Profit > plus500Profit) {
                bestPlatformEl.textContent = 'ü•á Mt4';
                bestPlatformEl.className = 'stat-value positive';
                bestPlatformReasonEl.textContent = `+‚Ç¨${(mt4Profit - plus500Profit).toFixed(2)} di vantaggio`;
            } else if (plus500Profit > mt4Profit) {
                bestPlatformEl.textContent = 'ü•á Plus500';
                bestPlatformEl.className = 'stat-value positive';
                bestPlatformReasonEl.textContent = `+‚Ç¨${(plus500Profit - mt4Profit).toFixed(2)} di vantaggio`;
            } else {
                bestPlatformEl.textContent = 'ü§ù Pari';
                bestPlatformEl.className = 'stat-value';
                bestPlatformReasonEl.textContent = 'Performance identiche';
            }
        }

        function updateObjectiveProgress(platform, points, target) {
            const progressElement = document.getElementById(`${platform}Progress`);
            const progressBarElement = document.getElementById(`${platform}ProgressBar`);
            const statusElement = document.getElementById(`${platform}Status`);
            
            progressElement.textContent = points.toFixed(2);
            
            const percentage = Math.min((Math.abs(points) / target) * 100, 100);
            progressBarElement.style.width = `${percentage}%`;
            
            if (points >= target) {
                statusElement.textContent = '‚úÖ Obiettivo raggiunto!';
                statusElement.style.color = '#28a745';
            } else if (points < 0) {
                statusElement.textContent = '‚ùå In perdita';
                statusElement.style.color = '#dc3545';
            } else {
                const remaining = target - points;
                statusElement.textContent = `üìà Mancano ${remaining.toFixed(2)} punti`;
                statusElement.style.color = '#6c757d';
            }
        }

        function getFilteredTrades() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return trades.filter(trade => {
                const tradeDate = new Date(trade.date);
                
                switch(currentPeriod) {
                    case 'daily':
                        return tradeDate.getTime() === today.getTime();
                    case 'weekly':
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        return tradeDate >= weekStart;
                    case 'monthly':
                        return tradeDate.getMonth() === today.getMonth() && 
                               tradeDate.getFullYear() === today.getFullYear();
                    default:
                        return true;
                }
            });
        }

        function getDaysInPeriod() {
            const now = new Date();
            
            switch(currentPeriod) {
                case 'daily':
                    return 1;
                case 'weekly':
                    return 7;
                case 'monthly':
                    return new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                default:
                    return 1;
            }
        }

        function initCharts() {
            const ctx1 = document.getElementById('profitChart');
            const ctx2 = document.getElementById('pointsChart');
            
            if (profitChart) profitChart.destroy();
            if (pointsChart) pointsChart.destroy();
            
            // Grafico ricavi separati per piattaforma
            profitChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Mt4 (‚Ç¨)',
                            data: [],
                            borderColor: '#1e3c72',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointBackgroundColor: '#1e3c72',
                            pointBorderColor: '#1e3c72',
                            pointRadius: 4
                        },
                        {
                            label: 'Plus500 (‚Ç¨)',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#667eea',
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        x: {
                            grid: {
                                color: '#f0f0f0'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            // Grafico punti per piattaforma
            pointsChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Mt4', 'Plus500'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#1e3c72', '#667eea'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            updateCharts();
        }

        function updateCharts() {
            const filteredTrades = getFilteredTrades();
            
            // Aggiorna grafico ricavi separati per piattaforma
            const mt4ProfitByDate = {};
            const plus500ProfitByDate = {};
            
            // Inizializza tutti i giorni del periodo con 0
            const allDates = [...new Set(filteredTrades.map(trade => trade.date))].sort();
            
            allDates.forEach(date => {
                mt4ProfitByDate[date] = 0;
                plus500ProfitByDate[date] = 0;
            });
            
            // Aggrega i ricavi per piattaforma e data
            filteredTrades.forEach(trade => {
                if (trade.platform === 'Mt4') {
                    mt4ProfitByDate[trade.date] += trade.profitLoss;
                } else if (trade.platform === 'Plus500') {
                    plus500ProfitByDate[trade.date] += trade.profitLoss;
                }
            });
            
            const dates = allDates;
            const mt4Profits = dates.map(date => mt4ProfitByDate[date] || 0);
            const plus500Profits = dates.map(date => plus500ProfitByDate[date] || 0);
            
            if (profitChart) {
                profitChart.data.labels = dates;
                profitChart.data.datasets[0].data = mt4Profits;
                profitChart.data.datasets[1].data = plus500Profits;
                profitChart.update();
            }
            
            // Aggiorna grafico punti
            const mt4Points = filteredTrades
                .filter(trade => trade.platform === 'Mt4')
                .reduce((sum, trade) => sum + Math.abs(trade.pointsRealized), 0);
            
            const plus500Points = filteredTrades
                .filter(trade => trade.platform === 'Plus500')
                .reduce((sum, trade) => sum + Math.abs(trade.pointsRealized), 0);
            
            if (pointsChart) {
                pointsChart.data.datasets[0].data = [mt4Points, plus500Points];
                pointsChart.update();
            }
        }

        function updateHistory() {
            const tbody = document.getElementById('historyBody');
            const sortedTrades = [...trades].sort((a, b) => b.timestamp - a.timestamp);
            
            tbody.innerHTML = sortedTrades.map(trade => `
                <tr>
                    <td>${new Date(trade.timestamp).toLocaleString('it-IT')}</td>
                    <td>${trade.platform}</td>
                    <td>${trade.lots}</td>
                    <td>‚Ç¨${trade.pointValue.toFixed(2)}</td>
                    <td class="${trade.pointsRealized >= 0 ? 'positive' : 'negative'}">${trade.pointsRealized.toFixed(2)}</td>
                    <td class="${trade.profitLoss >= 0 ? 'positive' : 'negative'}">‚Ç¨${trade.profitLoss.toFixed(2)}</td>
                    <td><button class="delete-btn" onclick="deleteTrade(${trade.id})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function deleteTrade(id) {
            const tradeToDelete = trades.find(trade => trade.id === id);
            if (!tradeToDelete) return;
            
            if (confirm('Sei sicuro di voler eliminare questa operazione?')) {
                // Elimina localmente
                trades = trades.filter(trade => trade.id !== id);
                localStorage.setItem('trades', JSON.stringify(trades));
                
                // Elimina da Firebase se connesso
                if (isFirebaseConnected) {
                    deleteTradeFromFirebase(tradeToDelete.timestamp);
                }
                
                updateHistory();
                showAlert('Operazione eliminata con successo!', 'success');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.main-content');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            // Inizializza status offline inizialmente
            updateConnectionStatus('offline');
            
            // Carica dati da Firebase se connesso (dopo inizializzazione)
            setTimeout(async () => {
                if (isFirebaseConnected) {
                    await loadTrades();
                    updateDashboard();
                    updateHistory();
                }
            }, 2000);
            
            // Aggiorna dashboard con dati locali immediatamente
            updateDashboard();
            updateHistory();
        });
    </script>
</body>
</html>
